<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>üéÆ Office Feud</title>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600;700;800&family=Barlow+Condensed:wght@400;600;700&family=Barlow:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* ============================================================
       SETUP INSTRUCTIONS (read before playing!)
       ============================================================
       1. Go to supabase.com ‚Üí create a FREE account & project
       2. Go to SQL Editor ‚Üí paste & run the contents of setup.sql
       3. Go to Project Settings ‚Üí API ‚Üí copy your URL and anon key
       4. Replace YOUR_SUPABASE_URL and YOUR_SUPABASE_ANON_KEY below
       5. Host this file on netlify.com (drag & drop, free!) or GitHub Pages
       6. Share the URL with your team!
       Moderator password: OFFICEFEUD2025
       ============================================================ */

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --navy: #0A1628;
      --navy2: #0f2040;
      --gold: #FFD700;
      --gold2: #FFA500;
      --red: #e63946;
      --green: #2dc653;
      --white: #ffffff;
      --gray: #8899aa;
      --card-bg: #112240;
      --card-border: #1e3a5f;
    }

    html, body {
      height: 100%;
      background: var(--navy);
      color: var(--white);
      font-family: 'Barlow', sans-serif;
      overflow-x: hidden;
    }

    body {
      background-image: 
        radial-gradient(ellipse at 20% 50%, rgba(255,215,0,0.04) 0%, transparent 60%),
        radial-gradient(ellipse at 80% 20%, rgba(30,80,160,0.15) 0%, transparent 50%);
      min-height: 100vh;
    }

    /* SCREENS */
    .screen {
      display: none;
      min-height: 100vh;
      padding: 16px;
      max-width: 900px;
      margin: 0 auto;
    }
    .screen.active { display: flex; flex-direction: column; }

    /* TYPOGRAPHY */
    .game-title {
      font-family: 'Oswald', sans-serif;
      font-weight: 800;
      font-size: clamp(2rem, 6vw, 3.5rem);
      background: linear-gradient(135deg, #FFD700, #FFA500, #FFD700);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-transform: uppercase;
      letter-spacing: 2px;
      text-align: center;
      line-height: 1.1;
    }
    .screen-title {
      font-family: 'Oswald', sans-serif;
      font-weight: 700;
      font-size: clamp(1.4rem, 4vw, 2rem);
      color: var(--gold);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    h3 {
      font-family: 'Oswald', sans-serif;
      font-weight: 600;
      color: var(--gold);
      font-size: 1.1rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* CARDS */
    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      padding: 20px;
    }

    /* BUTTONS */
    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      gap: 8px;
      padding: 14px 28px;
      border: none; border-radius: 8px;
      font-family: 'Oswald', sans-serif;
      font-weight: 700; font-size: 1.1rem;
      text-transform: uppercase; letter-spacing: 1px;
      cursor: pointer; transition: all 0.2s;
      min-height: 52px;
      width: 100%;
    }
    .btn-gold {
      background: linear-gradient(135deg, #FFD700, #FFA500);
      color: var(--navy);
    }
    .btn-gold:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(255,215,0,0.4); }
    .btn-gold:active { transform: translateY(0); }
    .btn-outline {
      background: transparent;
      border: 2px solid var(--gold);
      color: var(--gold);
    }
    .btn-outline:hover { background: rgba(255,215,0,0.1); }
    .btn-red { background: var(--red); color: white; }
    .btn-green { background: var(--green); color: white; }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }

    /* INPUTS */
    .input-field {
      width: 100%;
      padding: 14px 16px;
      background: rgba(255,255,255,0.07);
      border: 2px solid var(--card-border);
      border-radius: 8px;
      color: var(--white);
      font-size: 1rem;
      font-family: 'Barlow', sans-serif;
      outline: none;
      transition: border-color 0.2s;
    }
    .input-field:focus { border-color: var(--gold); }
    .input-field::placeholder { color: var(--gray); }
    label {
      display: block;
      font-family: 'Oswald', sans-serif;
      font-size: 0.85rem;
      letter-spacing: 1px;
      color: var(--gray);
      margin-bottom: 6px;
      text-transform: uppercase;
    }

    /* ERROR / SUCCESS */
    .msg { padding: 10px 14px; border-radius: 8px; font-size: 0.9rem; margin-top: 8px; }
    .msg-error { background: rgba(230,57,70,0.2); border: 1px solid var(--red); color: #ff8080; }
    .msg-success { background: rgba(45,198,83,0.15); border: 1px solid var(--green); color: #80ffa0; }
    .msg-info { background: rgba(255,215,0,0.1); border: 1px solid rgba(255,215,0,0.3); color: var(--gold); }

    /* DIVIDER */
    .divider {
      height: 1px; background: var(--card-border); margin: 16px 0;
    }

    /* BADGE */
    .badge {
      display: inline-block; padding: 4px 12px;
      background: rgba(255,215,0,0.15);
      border: 1px solid rgba(255,215,0,0.4);
      border-radius: 20px;
      font-family: 'Oswald', sans-serif;
      font-size: 0.8rem; letter-spacing: 1px;
      color: var(--gold); text-transform: uppercase;
    }

    /* ============================================================
       SCREEN 1: LOGIN
       ============================================================ */
    #screen-login {
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      gap: 24px;
    }
    .login-header { text-align: center; }
    .login-subtitle {
      color: var(--gray);
      margin-top: 8px;
      font-size: 1rem;
    }
    .login-box { width: 100%; max-width: 440px; }
    .login-form { display: flex; flex-direction: column; gap: 16px; }
    .mod-toggle-row {
      display: flex; align-items: center; gap: 10px;
      cursor: pointer; padding: 8px 0;
    }
    .mod-toggle-row input[type="checkbox"] {
      width: 18px; height: 18px; accent-color: var(--gold); cursor: pointer;
    }
    .mod-toggle-row span { font-size: 0.9rem; color: var(--gray); }

    /* ============================================================
       SCREEN 2: LOBBY / WAITING ROOM
       ============================================================ */
    #screen-lobby { gap: 20px; padding-top: 24px; }
    .lobby-header { text-align: center; }
    .player-count {
      display: inline-block;
      font-family: 'Oswald', sans-serif;
      font-size: 2.5rem; font-weight: 700;
      color: var(--gold);
    }
    .rules-list {
      list-style: none;
      display: flex; flex-direction: column; gap: 10px;
    }
    .rules-list li {
      display: flex; gap: 12px; align-items: flex-start;
      font-size: 0.95rem; line-height: 1.5;
    }
    .rule-icon {
      font-size: 1.1rem; flex-shrink: 0; margin-top: 1px;
    }
    .players-grid {
      display: flex; flex-wrap: wrap; gap: 8px;
    }
    .player-chip {
      background: rgba(255,215,0,0.1);
      border: 1px solid rgba(255,215,0,0.3);
      border-radius: 20px;
      padding: 5px 14px;
      font-size: 0.85rem;
      color: var(--gold);
      animation: popIn 0.3s ease;
    }
    .player-chip.mod { border-color: var(--gold); background: rgba(255,215,0,0.2); }
    @keyframes popIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .waiting-msg {
      text-align: center; color: var(--gray);
      font-style: italic; padding: 8px 0;
      animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }

    /* ============================================================
       SCREEN 3: QUESTION
       ============================================================ */
    #screen-question { gap: 16px; padding-top: 16px; }

    /* Top bar */
    .q-topbar {
      display: flex; justify-content: space-between; align-items: center;
      background: var(--card-bg); border-radius: 10px; padding: 10px 16px;
      border: 1px solid var(--card-border);
      position: sticky; top: 8px; z-index: 10;
    }
    .q-counter {
      font-family: 'Oswald', sans-serif;
      font-weight: 700; font-size: 1rem;
      color: var(--gray);
    }
    .q-counter span { color: var(--white); }
    .q-score-display {
      font-family: 'Oswald', sans-serif;
      font-size: 0.9rem; color: var(--gold);
    }
    .q-score-display strong { font-size: 1.2rem; }

    /* Timer */
    .timer-wrap {
      display: flex; justify-content: center;
    }
    .timer-circle {
      position: relative; width: 80px; height: 80px;
    }
    .timer-svg {
      transform: rotate(-90deg);
      width: 80px; height: 80px;
    }
    .timer-bg { fill: none; stroke: #1e3a5f; stroke-width: 6; }
    .timer-arc {
      fill: none; stroke: var(--gold); stroke-width: 6;
      stroke-linecap: round;
      stroke-dasharray: 226;
      stroke-dashoffset: 0;
      transition: stroke-dashoffset 1s linear, stroke 0.3s;
    }
    .timer-arc.urgent { stroke: var(--red); }
    .timer-num {
      position: absolute; inset: 0;
      display: flex; align-items: center; justify-content: center;
      font-family: 'Oswald', sans-serif;
      font-size: 1.6rem; font-weight: 700;
    }
    .timer-num.urgent { color: var(--red); }

    /* Question text */
    .q-text {
      font-family: 'Oswald', sans-serif;
      font-size: clamp(1.2rem, 3.5vw, 1.8rem);
      font-weight: 700;
      text-align: center;
      line-height: 1.3;
      padding: 0 8px;
    }

    /* Answer grid */
    .answers-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    @media (max-width: 399px) {
      .answers-grid { grid-template-columns: 1fr; }
    }
    @media (min-width: 700px) {
      .answers-grid { grid-template-columns: repeat(4, 1fr); }
    }

    .ans-btn {
      padding: 14px 10px;
      min-height: 64px;
      background: var(--card-bg);
      border: 2px solid var(--card-border);
      border-radius: 10px;
      color: var(--white);
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 1rem; font-weight: 600;
      cursor: pointer; transition: all 0.2s;
      display: flex; align-items: center; justify-content: center;
      text-align: center;
      line-height: 1.2;
    }
    .ans-btn:hover:not(:disabled) {
      border-color: var(--gold);
      background: rgba(255,215,0,0.1);
      transform: translateY(-2px);
    }
    .ans-btn.selected {
      border-color: var(--gold);
      background: rgba(255,215,0,0.2);
      color: var(--gold);
    }
    .ans-btn:disabled { cursor: not-allowed; opacity: 0.6; }
    .ans-btn:disabled:not(.selected) { opacity: 0.4; }

    .locked-msg {
      text-align: center;
      font-size: 0.95rem;
      color: var(--green);
      animation: pulse 1.5s ease-in-out infinite;
    }
    .mod-answer-status {
      background: rgba(30,58,95,0.8);
      border: 1px solid var(--card-border);
      border-radius: 10px; padding: 12px 16px;
      display: flex; justify-content: space-between; align-items: center;
      font-size: 0.9rem;
    }
    .answered-count {
      font-family: 'Oswald', sans-serif;
      font-size: 1.3rem; color: var(--gold);
    }

    /* ============================================================
       SCREEN 4: ANSWER REVEAL (Family Feud board)
       ============================================================ */
    #screen-reveal { gap: 16px; padding-top: 20px; }

    .reveal-header { text-align: center; }
    .reveal-qtext {
      font-family: 'Oswald', sans-serif;
      font-size: clamp(1rem, 3vw, 1.4rem);
      font-weight: 600;
      color: var(--gray);
      text-align: center;
      font-style: italic;
    }

    .feud-board {
      display: flex; flex-direction: column; gap: 8px;
    }

    .feud-row {
      display: flex; align-items: stretch;
      border-radius: 8px; overflow: hidden;
      height: 52px;
      opacity: 0;
      transform: translateX(-20px);
      transition: opacity 0.4s, transform 0.4s;
    }
    .feud-row.revealed {
      opacity: 1; transform: translateX(0);
    }

    .feud-rank {
      width: 44px; flex-shrink: 0;
      background: var(--navy2);
      display: flex; align-items: center; justify-content: center;
      font-family: 'Oswald', sans-serif;
      font-size: 1.1rem; font-weight: 700;
      color: var(--gold);
      border-right: 2px solid var(--gold);
    }

    .feud-answer-text {
      flex: 1;
      background: var(--navy2);
      display: flex; align-items: center;
      padding: 0 14px;
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 1rem; font-weight: 600;
      position: relative;
      overflow: hidden;
    }
    .feud-bar {
      position: absolute; left: 0; top: 0; bottom: 0;
      background: linear-gradient(90deg, rgba(255,215,0,0.15), transparent);
      transition: width 0.8s ease;
    }
    .feud-answer-label { position: relative; z-index: 1; }

    .feud-score {
      width: 52px; flex-shrink: 0;
      background: var(--gold);
      display: flex; align-items: center; justify-content: center;
      font-family: 'Oswald', sans-serif;
      font-size: 1.3rem; font-weight: 800;
      color: var(--navy);
    }

    .feud-row:nth-child(1) .feud-rank { color: #FFD700; }
    .feud-row:nth-child(2) .feud-rank { color: #E8E8E8; }
    .feud-row:nth-child(3) .feud-rank { color: #CD7F32; }

    .my-result {
      background: var(--card-bg);
      border: 2px solid var(--card-border);
      border-radius: 10px; padding: 16px;
      text-align: center;
    }
    .my-result.correct-top { border-color: var(--gold); }
    .my-result-score {
      font-family: 'Oswald', sans-serif;
      font-size: 2rem; font-weight: 800;
      color: var(--gold);
    }
    .top-answer-badge {
      display: inline-block;
      background: linear-gradient(135deg, #FFD700, #FFA500);
      color: var(--navy); border-radius: 20px;
      padding: 4px 14px;
      font-family: 'Oswald', sans-serif;
      font-size: 0.85rem; font-weight: 700;
      letter-spacing: 1px; text-transform: uppercase;
      margin-top: 6px;
    }

    /* ============================================================
       SCREEN 5: LEADERBOARD
       ============================================================ */
    #screen-leaderboard { gap: 20px; padding-top: 20px; }

    .podium-row {
      display: flex; justify-content: center; gap: 12px;
      align-items: flex-end; margin: 10px 0;
    }
    .podium-item {
      display: flex; flex-direction: column; align-items: center;
      gap: 6px; text-align: center;
    }
    .podium-trophy { font-size: 2.5rem; animation: bounce 1s ease infinite alternate; }
    .podium-item:nth-child(1) .podium-trophy { font-size: 3rem; animation-delay: 0s; }
    .podium-item:nth-child(2) .podium-trophy { animation-delay: 0.15s; }
    .podium-item:nth-child(3) .podium-trophy { animation-delay: 0.3s; }
    @keyframes bounce {
      from { transform: translateY(0); }
      to { transform: translateY(-8px); }
    }
    .podium-name {
      font-family: 'Oswald', sans-serif;
      font-weight: 700; font-size: 1rem;
      max-width: 90px; word-break: break-all;
      line-height: 1.1;
    }
    .podium-score {
      font-family: 'Oswald', sans-serif;
      font-size: 1.3rem; font-weight: 800;
      color: var(--gold);
    }
    .podium-block {
      width: 80px; border-radius: 6px 6px 0 0;
      background: linear-gradient(180deg, rgba(255,215,0,0.3), rgba(255,165,0,0.15));
      border: 1px solid rgba(255,215,0,0.4);
    }

    .lb-list { display: flex; flex-direction: column; gap: 6px; }
    .lb-row {
      display: flex; align-items: center; gap: 12px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 8px; padding: 10px 14px;
      animation: slideIn 0.3s ease;
    }
    .lb-row.me { border-color: rgba(255,215,0,0.5); background: rgba(255,215,0,0.07); }
    @keyframes slideIn {
      from { transform: translateX(-20px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .lb-rank {
      font-family: 'Oswald', sans-serif;
      font-size: 1.3rem; font-weight: 700;
      color: var(--gray);
      width: 30px; flex-shrink: 0;
    }
    .lb-name { flex: 1; font-weight: 500; font-size: 0.95rem; }
    .lb-score {
      font-family: 'Oswald', sans-serif;
      font-size: 1.1rem; font-weight: 700;
      color: var(--gold);
    }
    .lb-delta {
      font-size: 0.8rem; width: 26px; text-align: center;
    }
    .lb-delta.up { color: var(--green); }
    .lb-delta.down { color: var(--red); }
    .lb-delta.same { color: var(--gray); }

    .rank-msg {
      text-align: center; padding: 12px 16px;
      background: rgba(255,215,0,0.07);
      border: 1px solid rgba(255,215,0,0.2);
      border-radius: 10px;
      font-style: italic; font-size: 0.95rem;
      color: var(--gold);
    }

    /* ============================================================
       SCREEN 6: END / FINAL
       ============================================================ */
    #screen-end { gap: 24px; padding-top: 20px; align-items: center; }
    .end-hero { text-align: center; }
    .end-emoji { font-size: 4rem; animation: spin 2s ease; }
    @keyframes spin {
      from { transform: rotate(-20deg) scale(0.5); opacity: 0; }
      to { transform: rotate(0) scale(1); opacity: 1; }
    }
    .end-headline {
      font-family: 'Oswald', sans-serif;
      font-size: clamp(1.2rem, 4vw, 1.8rem);
      font-weight: 800; color: var(--gold);
      margin-top: 12px;
      line-height: 1.2;
    }
    .end-sub { color: var(--gray); margin-top: 8px; font-size: 0.95rem; }

    /* ============================================================
       CONFETTI CANVAS
       ============================================================ */
    #confetti-canvas {
      position: fixed; inset: 0;
      pointer-events: none; z-index: 100;
    }

    /* ============================================================
       TOAST
       ============================================================ */
    #toast {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(100px);
      background: var(--card-bg); border: 1px solid var(--card-border);
      border-radius: 8px; padding: 12px 20px;
      font-family: 'Oswald', sans-serif; font-size: 1rem;
      color: var(--gold); letter-spacing: 0.5px;
      transition: transform 0.3s; z-index: 200; white-space: nowrap;
      box-shadow: 0 8px 30px rgba(0,0,0,0.5);
    }
    #toast.show { transform: translateX(-50%) translateY(0); }

    /* PLAYERS ONLINE INDICATOR */
    #online-indicator {
      position: fixed; top: 10px; right: 12px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 20px; padding: 4px 12px;
      font-size: 0.75rem; color: var(--gray);
      display: flex; align-items: center; gap: 6px;
      z-index: 50;
    }
    .online-dot {
      width: 7px; height: 7px; border-radius: 50%;
      background: var(--green);
      animation: pulse 2s ease-in-out infinite;
    }

    /* UTILITY */
    .flex-col { display: flex; flex-direction: column; }
    .gap-sm { gap: 8px; }
    .gap-md { gap: 16px; }
    .gap-lg { gap: 24px; }
    .text-center { text-align: center; }
    .text-gray { color: var(--gray); font-size: 0.9rem; }
    .mt-auto { margin-top: auto; }
    .w-full { width: 100%; }

    /* SPACER */
    .spacer { flex: 1; }

    @media (min-width: 600px) {
      .screen { padding: 24px; }
      .answers-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>

<canvas id="confetti-canvas"></canvas>
<div id="online-indicator">
  <div class="online-dot"></div>
  <span id="online-count">0 online</span>
</div>
<div id="toast"></div>

<!-- ============================================================
     SCREEN 1: LOGIN
============================================================ -->
<div id="screen-login" class="screen active">
  <div class="login-header">
    <div class="game-title">üéÆ Office Feud</div>
    <p class="login-subtitle">The Remote Team Game Show</p>
  </div>
  <div class="login-box card">
    <div class="login-form">
      <div>
        <label>Your Name</label>
        <input type="text" id="name-input" class="input-field" placeholder="Enter your name..." maxlength="30" autocomplete="off">
      </div>
      <div class="mod-toggle-row" onclick="document.getElementById('mod-check').click()">
        <input type="checkbox" id="mod-check">
        <span>I am the Moderator</span>
      </div>
      <div id="mod-pw-wrap" style="display:none">
        <label>Moderator Password</label>
        <input type="password" id="mod-pw" class="input-field" placeholder="Enter moderator password...">
      </div>
      <div id="login-msg"></div>
      <button class="btn btn-gold" onclick="handleLogin()">Join the Game ‚Üí</button>
    </div>
  </div>
  <p class="text-center text-gray" style="margin-top:8px">Survey of 50 colleagues ¬∑ 20 questions ¬∑ Pure fun üéâ</p>
</div>

<!-- ============================================================
     SCREEN 2: LOBBY
============================================================ -->
<div id="screen-lobby" class="screen">
  <div class="lobby-header">
    <div class="game-title">Office Feud</div>
    <div style="margin-top:8px">
      <span class="badge">Waiting Room</span>
    </div>
  </div>

  <div class="card">
    <div style="text-align:center;margin-bottom:12px">
      <div style="color:var(--gray);font-size:0.85rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Players Joined</div>
      <div class="player-count" id="lobby-player-count">0</div>
    </div>
    <div class="players-grid" id="lobby-players-list"></div>
  </div>

  <div class="card">
    <h3 style="margin-bottom:12px">üìã How to Play</h3>
    <ul class="rules-list">
      <li><span class="rule-icon">üéØ</span><span>20 questions based on a real survey of your colleagues</span></li>
      <li><span class="rule-icon">‚è±Ô∏è</span><span>You have <strong>15 seconds</strong> per question to pick an answer</span></li>
      <li><span class="rule-icon">‚ö°</span><span>Answer in <strong>1‚Äì5 sec ‚Üí 1.1√ó score bonus</strong></span></li>
      <li><span class="rule-icon">üèÉ</span><span>Answer in <strong>5‚Äì10 sec ‚Üí 1.05√ó score bonus</strong></span></li>
      <li><span class="rule-icon">üïê</span><span>Answer in <strong>10‚Äì15 sec ‚Üí exact score</strong></span></li>
      <li><span class="rule-icon">üèÜ</span><span>Standings revealed after every 5 questions!</span></li>
      <li><span class="rule-icon">üé¨</span><span>The Moderator controls the pace ‚Äî follow their lead!</span></li>
    </ul>
  </div>

  <div id="lobby-mod-btn" style="display:none">
    <button class="btn btn-gold" onclick="startGame()">üöÄ Start Game!</button>
  </div>
  <div id="lobby-wait-msg" class="waiting-msg">‚è≥ Waiting for the Moderator to start the game...</div>
  <div class="spacer"></div>
</div>

<!-- ============================================================
     SCREEN 3: QUESTION
============================================================ -->
<div id="screen-question" class="screen">
  <div class="q-topbar">
    <div class="q-counter">Q <span id="q-num">1</span>/20</div>
    <div class="q-score-display">Score: <strong id="q-score">0</strong></div>
  </div>

  <div class="timer-wrap">
    <div class="timer-circle">
      <svg class="timer-svg" viewBox="0 0 80 80">
        <circle class="timer-bg" cx="40" cy="40" r="36"/>
        <circle class="timer-arc" id="timer-arc" cx="40" cy="40" r="36"/>
      </svg>
      <div class="timer-num" id="timer-num">15</div>
    </div>
  </div>

  <div class="q-text" id="q-text">Question text goes here</div>

  <div class="answers-grid" id="answers-grid"></div>

  <div id="locked-msg" class="locked-msg" style="display:none">‚úÖ Answer locked in! Waiting for others...</div>

  <div id="mod-answer-status" class="mod-answer-status" style="display:none">
    <div>
      <span class="answered-count" id="answered-count">0</span>
      <span class="text-gray"> / </span>
      <span id="total-count" class="text-gray">0 answered</span>
    </div>
    <button class="btn btn-outline" style="width:auto;padding:8px 16px;font-size:0.85rem" onclick="forceReveal()">Skip Timer & Reveal</button>
  </div>
  <div class="spacer"></div>
</div>

<!-- ============================================================
     SCREEN 4: ANSWER REVEAL
============================================================ -->
<div id="screen-reveal" class="screen">
  <div class="reveal-header">
    <div class="screen-title">Survey Says!</div>
    <div class="reveal-qtext" id="reveal-qtext"></div>
  </div>

  <div class="feud-board" id="feud-board"></div>

  <div class="my-result" id="my-result">
    <div style="color:var(--gray);font-size:0.85rem;margin-bottom:4px">Your Answer: <strong id="my-answer-text" style="color:white">‚Äî</strong></div>
    <div class="my-result-score">+<span id="my-earned">0</span> pts</div>
    <div id="top-answer-badge" style="display:none" class="top-answer-badge">üîù Top Answer!</div>
  </div>

  <div class="card" style="text-align:center">
    <div style="color:var(--gray);font-size:0.85rem">Total Score</div>
    <div style="font-family:'Oswald',sans-serif;font-size:2rem;font-weight:800;color:var(--gold)" id="reveal-total">0</div>
  </div>

  <div id="reveal-mod-btn" style="display:none">
    <button class="btn btn-gold" id="reveal-next-btn" onclick="moderatorNext()">‚û°Ô∏è Next Question</button>
  </div>
  <div id="reveal-wait-msg" class="waiting-msg">‚è≥ Waiting for the Moderator to continue...</div>
  <div class="spacer"></div>
</div>

<!-- ============================================================
     SCREEN 5: LEADERBOARD
============================================================ -->
<div id="screen-leaderboard" class="screen">
  <div style="text-align:center">
    <div class="screen-title" id="lb-title">üèÜ Standings After Q5</div>
    <div class="badge" id="lb-subtitle">Halfway there!</div>
  </div>

  <div class="podium-row" id="podium-row"></div>
  <div class="rank-msg" id="my-rank-msg"></div>

  <div>
    <h3 style="margin-bottom:10px">Full Rankings</h3>
    <div class="lb-list" id="lb-full-list"></div>
  </div>

  <div id="lb-mod-btn" style="display:none">
    <button class="btn btn-gold" id="lb-next-btn" onclick="moderatorNext()">‚ñ∂Ô∏è Continue to Next Question</button>
  </div>
  <div id="lb-wait-msg" class="waiting-msg">‚è≥ Waiting for the Moderator...</div>
  <div class="spacer"></div>
</div>

<!-- ============================================================
     SCREEN 6: END
============================================================ -->
<div id="screen-end" class="screen">
  <div class="end-hero">
    <div class="end-emoji">üèÜ</div>
    <div class="end-headline" id="end-headline">And the winner is...</div>
    <div class="end-sub">Office Feud Champion!</div>
  </div>

  <div class="podium-row" id="end-podium-row"></div>

  <div class="w-full">
    <h3 style="margin-bottom:10px">Final Leaderboard</h3>
    <div class="lb-list" id="end-lb-list"></div>
  </div>

  <div class="card text-center" style="width:100%">
    <div style="font-size:2rem;margin-bottom:8px">üéâ</div>
    <div style="font-family:'Oswald',sans-serif;font-size:1.5rem;font-weight:700;color:var(--gold)">Thanks for Playing Office Feud!</div>
    <div style="color:var(--gray);margin-top:8px;font-size:0.95rem">You're all stars ‚Äî see you at the next one! üöÄ</div>
  </div>

  <button class="btn btn-outline" onclick="window.print()">üìÑ Save/Print Results</button>
  <div class="spacer"></div>
</div>

<script>
// ============================================================
// CONFIGURATION ‚Äî REPLACE THESE WITH YOUR SUPABASE CREDENTIALS
// ============================================================
const SUPABASE_URL = 'https://bphqkqgtsocoebfywftf.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_BYQ5H1Q0zwHrYDXOsOc43Q_U3dkJDf4';
const MOD_PASSWORD = 'OFFICEFEUD2025';
// ============================================================

// ============================================================
// QUESTIONS DATA
// ============================================================
const QUESTIONS = [
  {
    q: "Name the most-used emoji in your work Slack or Teams chat.",
    answers: [
      { text: "üëç Thumbs Up", score: 18 },
      { text: "üòÇ Laughing Face", score: 9 },
      { text: "üôè Folded Hands", score: 7 },
      { text: "üî• Fire", score: 5 },
      { text: "‚ù§Ô∏è Heart", score: 4 },
      { text: "üëÄ Eyes", score: 3 },
      { text: "‚úÖ Check Mark", score: 2 },
      { text: "üéâ Party Popper", score: 2 }
    ]
  },
  {
    q: "Name the first thing you do when you log in for work in the morning.",
    answers: [
      { text: "Check Slack/Teams", score: 19 },
      { text: "Check Email", score: 13 },
      { text: "Look at my Calendar", score: 8 },
      { text: "Check Task Manager", score: 4 },
      { text: "Open Dashboards", score: 3 },
      { text: "Scroll LinkedIn", score: 1 },
      { text: "Make Coffee First", score: 1 },
      { text: "Check colleague status", score: 1 }
    ]
  },
  {
    q: "Name something people do during a boring video call.",
    answers: [
      { text: "Browse their phone", score: 17 },
      { text: "Check emails", score: 12 },
      { text: "Online shopping", score: 7 },
      { text: "Mute and talk to someone", score: 5 },
      { text: "Scroll social media", score: 4 },
      { text: "Doodle / take fake notes", score: 3 },
      { text: "Watch something else", score: 1 },
      { text: "Order food", score: 1 }
    ]
  },
  {
    q: "Name a phrase used way too much in meetings.",
    answers: [
      { text: "Let's take this offline", score: 16 },
      { text: "Can everyone hear me?", score: 11 },
      { text: "Circle back", score: 9 },
      { text: "Quick sync", score: 5 },
      { text: "Move the needle", score: 4 },
      { text: "Bandwidth", score: 3 },
      { text: "Align on this", score: 1 },
      { text: "At the end of the day", score: 1 }
    ]
  },
  {
    q: "Name a reason someone is late to a virtual meeting.",
    answers: [
      { text: "Previous meeting ran long", score: 20 },
      { text: "Forgot about it", score: 11 },
      { text: "Couldn't find the link", score: 8 },
      { text: "Internet/tech issues", score: 5 },
      { text: "Kids or home interruption", score: 3 },
      { text: "Wrong time zone", score: 1 },
      { text: "Was on another call", score: 1 },
      { text: "Getting coffee", score: 1 }
    ]
  },
  {
    q: "Name something that always goes wrong on a video call.",
    answers: [
      { text: "Mic is muted", score: 18 },
      { text: "Internet drops", score: 12 },
      { text: "Echo or feedback", score: 7 },
      { text: "Camera won't turn on", score: 5 },
      { text: "Screen share doesn't work", score: 4 },
      { text: "Background noise", score: 2 },
      { text: "Someone freezes", score: 1 },
      { text: "Wrong window shared", score: 1 }
    ]
  },
  {
    q: "Name the most overused word in marketing.",
    answers: [
      { text: "Synergy", score: 14 },
      { text: "Disruptive", score: 11 },
      { text: "Leverage", score: 9 },
      { text: "Authentic", score: 6 },
      { text: "Scalable", score: 5 },
      { text: "Data-driven", score: 3 },
      { text: "Holistic", score: 1 },
      { text: "Pivot", score: 1 }
    ]
  },
  {
    q: "Name your go-to work-from-home snack.",
    answers: [
      { text: "Chips", score: 16 },
      { text: "Coffee/Tea", score: 12 },
      { text: "Nuts", score: 8 },
      { text: "Biscuits/Cookies", score: 6 },
      { text: "Fruit", score: 4 },
      { text: "Chocolate", score: 2 },
      { text: "Bread/Toast", score: 1 },
      { text: "Protein bar", score: 1 }
    ]
  },
  {
    q: "Name the biggest distraction when working from home.",
    answers: [
      { text: "Phone/social media", score: 18 },
      { text: "Family or kids", score: 14 },
      { text: "TV in the background", score: 7 },
      { text: "Pets", score: 5 },
      { text: "Household chores", score: 3 },
      { text: "Delivery/doorbell", score: 1 },
      { text: "Neighbors", score: 1 },
      { text: "Napping", score: 1 }
    ]
  },
  {
    q: "Name the best part about working remotely.",
    answers: [
      { text: "No commute", score: 20 },
      { text: "Work in pajamas", score: 12 },
      { text: "Flexible hours", score: 8 },
      { text: "More family time", score: 5 },
      { text: "Better focus", score: 2 },
      { text: "Home-cooked food", score: 1 },
      { text: "No office politics", score: 1 },
      { text: "My own music", score: 1 }
    ]
  },
  {
    q: "Name something people fake on video calls.",
    answers: [
      { text: "Paying attention", score: 19 },
      { text: "Laughing at the right time", score: 11 },
      { text: "Taking notes", score: 8 },
      { text: "Bad internet to avoid speaking", score: 5 },
      { text: "Looking busy", score: 4 },
      { text: "Smiling", score: 1 },
      { text: "Being about to reply", score: 1 },
      { text: "Enthusiasm", score: 1 }
    ]
  },
  {
    q: "Name a type of meeting that could have been an email.",
    answers: [
      { text: "Status update call", score: 19 },
      { text: "Weekly team standup", score: 13 },
      { text: "Quick alignment call", score: 8 },
      { text: "Monday morning all-hands", score: 5 },
      { text: "Project kickoff", score: 2 },
      { text: "Retrospective", score: 1 },
      { text: "Reporting meeting", score: 1 },
      { text: "One-on-one catch-up", score: 1 }
    ]
  },
  {
    q: "Name something on your work desk right now.",
    answers: [
      { text: "Coffee mug", score: 17 },
      { text: "Notebook/Notepad", score: 12 },
      { text: "Phone", score: 8 },
      { text: "Headphones", score: 6 },
      { text: "Water bottle", score: 4 },
      { text: "Sticky notes", score: 1 },
      { text: "Charger/cables", score: 1 },
      { text: "A snack", score: 1 }
    ]
  },
  {
    q: "Name a Slack/Teams reaction you use all the time.",
    answers: [
      { text: "üëç Thumbs Up", score: 17 },
      { text: "‚ù§Ô∏è Heart", score: 10 },
      { text: "üòÇ Laugh", score: 8 },
      { text: "üéâ Tada", score: 6 },
      { text: "üëÄ Eyes", score: 4 },
      { text: "üî• Fire", score: 3 },
      { text: "‚úÖ Check", score: 1 },
      { text: "üôå Raising Hands", score: 1 }
    ]
  },
  {
    q: "Name what you do in the last 5 minutes before logging off.",
    answers: [
      { text: "Check Slack one last time", score: 16 },
      { text: "Update task manager", score: 11 },
      { text: "Send a final email", score: 9 },
      { text: "Close all 47 tabs", score: 6 },
      { text: "Write tomorrow's plan", score: 4 },
      { text: "Ghost everyone üëª", score: 2 },
      { text: "Say bye on Slack", score: 1 },
      { text: "Just close the laptop", score: 1 }
    ]
  },
  {
    q: "Name the marketing metric teams obsess over the most.",
    answers: [
      { text: "ROI", score: 17 },
      { text: "Conversion rate", score: 12 },
      { text: "CTR (Click-through rate)", score: 8 },
      { text: "CAC (Customer Acquisition Cost)", score: 6 },
      { text: "Revenue/Sales", score: 4 },
      { text: "Impressions", score: 1 },
      { text: "Engagement rate", score: 1 },
      { text: "Bounce rate", score: 1 }
    ]
  },
  {
    q: "Name a tool that sends you way too many notifications.",
    answers: [
      { text: "Slack", score: 21 },
      { text: "Email/Outlook", score: 13 },
      { text: "Jira", score: 7 },
      { text: "Asana", score: 4 },
      { text: "Google Calendar", score: 2 },
      { text: "LinkedIn", score: 1 },
      { text: "Teams", score: 1 },
      { text: "Notion", score: 1 }
    ]
  },
  {
    q: "Name something you'd add to your home office if money were no object.",
    answers: [
      { text: "Better chair/standing desk", score: 17 },
      { text: "Bigger/multiple monitors", score: 12 },
      { text: "Better lighting/ring light", score: 8 },
      { text: "Faster internet", score: 6 },
      { text: "A coffee machine", score: 4 },
      { text: "Soundproofing", score: 1 },
      { text: "A treadmill", score: 1 },
      { text: "A dedicated room", score: 1 }
    ]
  },
  {
    q: "Name something that happens the moment you say 'I have no meetings today.'",
    answers: [
      { text: "A meeting gets added", score: 21 },
      { text: "Someone pings for a quick call", score: 14 },
      { text: "An urgent Slack message", score: 7 },
      { text: "A deadline appears", score: 4 },
      { text: "Manager asks for catch-up", score: 2 },
      { text: "A fire drill begins", score: 1 },
      { text: "Calendar invite comes instantly", score: 1 },
      { text: "Someone asks 'can we hop on a call?'", score: 0 }
    ]
  },
  {
    q: "Name the first thing you do after logging off from work.",
    answers: [
      { text: "Watch TV/Netflix", score: 16 },
      { text: "Make/eat dinner", score: 12 },
      { text: "Go for a walk", score: 9 },
      { text: "Scroll social media", score: 6 },
      { text: "Exercise/gym", score: 4 },
      { text: "Spend time with family", score: 1 },
      { text: "Nap", score: 1 },
      { text: "Check email one more time üòÖ", score: 1 }
    ]
  }
];

// ============================================================
// APP STATE
// ============================================================
let sb;
let playerName = null;
let isModerator = false;
let playerScore = 0;
let currentGameState = null;
let timerInterval = null;
let hasAnswered = false;
let myAnswerIndex = -1;
let myEarnedThisQ = 0;
let prevLeaderboard = [];
let gameChannel = null;

// ============================================================
// INIT
// ============================================================
async function init() {
  if (SUPABASE_URL === 'YOUR_SUPABASE_URL') {
    showMsg('login-msg', '‚ö†Ô∏è Please configure your Supabase URL and key in the source code!', 'error');
    return;
  }
  sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Check for saved session
  const savedName = localStorage.getItem('officefeud_name');
  const savedMod = localStorage.getItem('officefeud_mod') === 'true';
  if (savedName) {
    const { data } = await sb.from('players').select('*').eq('name', savedName).maybeSingle();
    if (data) {
      playerName = data.name;
      isModerator = data.is_moderator;
      playerScore = data.score || 0;
      subscribeToAll();
      await syncCurrentState();
      return;
    }
  }
  showScreen('login');
}

// ============================================================
// LOGIN
// ============================================================
document.getElementById('mod-check').addEventListener('change', function() {
  document.getElementById('mod-pw-wrap').style.display = this.checked ? 'block' : 'none';
});

document.getElementById('name-input').addEventListener('keyup', function(e) {
  if (e.key === 'Enter') handleLogin();
});

async function handleLogin() {
  const nameRaw = document.getElementById('name-input').value.trim();
  const isModCheck = document.getElementById('mod-check').checked;
  const modPw = document.getElementById('mod-pw').value;
  const msgEl = document.getElementById('login-msg');

  if (!nameRaw || nameRaw.length < 2) {
    showMsg('login-msg', 'Please enter at least 2 characters for your name.', 'error'); return;
  }
  if (nameRaw.length > 30) {
    showMsg('login-msg', 'Name too long (max 30 characters).', 'error'); return;
  }

  if (isModCheck && modPw !== MOD_PASSWORD) {
    showMsg('login-msg', '‚ùå Wrong moderator password!', 'error'); return;
  }

  // Check if moderator slot taken
  if (isModCheck) {
    const { data: existingMod } = await sb.from('players').select('id').eq('is_moderator', true).maybeSingle();
    if (existingMod) {
      showMsg('login-msg', '‚ùå Moderator seat is already taken!', 'error'); return;
    }
  }

  // Check unique name
  const { data: existing } = await sb.from('players').select('id').eq('name', nameRaw).maybeSingle();
  if (existing) {
    showMsg('login-msg', "üòÑ That name's taken! Pick another one.", 'error'); return;
  }

  // Insert player
  const { error } = await sb.from('players').insert({
    name: nameRaw,
    score: 0,
    is_moderator: isModCheck
  });

  if (error) {
    showMsg('login-msg', '‚ùå Error joining: ' + error.message, 'error'); return;
  }

  playerName = nameRaw;
  isModerator = isModCheck;
  playerScore = 0;
  localStorage.setItem('officefeud_name', playerName);
  localStorage.setItem('officefeud_mod', String(isModerator));

  subscribeToAll();
  await syncCurrentState();
}

// ============================================================
// REAL-TIME SUBSCRIPTIONS
// ============================================================
function subscribeToAll() {
  // Subscribe to game_state changes
  gameChannel = sb.channel('office-feud-game')
    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'game_state', filter: 'id=eq.1' },
      payload => { handleGameStateChange(payload.new); })
    .on('postgres_changes', { event: '*', schema: 'public', table: 'players' },
      () => { refreshPlayerList(); updateOnlineCount(); })
    .subscribe();

  // Subscribe to answers for moderator count
  sb.channel('answers-channel')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'answers' },
      () => { if (isModerator) updateAnsweredCount(); })
    .subscribe();
}

async function syncCurrentState() {
  const { data } = await sb.from('game_state').select('*').eq('id', 1).maybeSingle();
  if (data) handleGameStateChange(data);
  else showScreen('lobby');
  updateOnlineCount();
}

// ============================================================
// GAME STATE MACHINE
// ============================================================
async function handleGameStateChange(state) {
  currentGameState = state;
  const phase = state.phase;
  const qIdx = state.current_question || 0;

  if (phase === 'lobby') {
    showScreen('lobby');
    refreshPlayerList();
  } else if (phase === 'question') {
    hasAnswered = false;
    myAnswerIndex = -1;
    myEarnedThisQ = 0;
    // Check if already answered this question
    const { data: existingAns } = await sb.from('answers')
      .select('*').eq('player_name', playerName).eq('question_index', qIdx).maybeSingle();
    if (existingAns) {
      hasAnswered = true;
      myAnswerIndex = existingAns.answer_index;
      myEarnedThisQ = existingAns.multiplied_score;
    }
    renderQuestionScreen(qIdx, state.question_start_time);
  } else if (phase === 'reveal') {
    stopTimer();
    renderRevealScreen(qIdx);
  } else if (phase === 'leaderboard') {
    renderLeaderboardScreen(qIdx);
  } else if (phase === 'end') {
    renderEndScreen();
  }
}

// ============================================================
// LOBBY
// ============================================================
async function refreshPlayerList() {
  if (!document.getElementById('screen-lobby').classList.contains('active')) return;
  const { data } = await sb.from('players').select('*').order('joined_at');
  if (!data) return;
  const count = data.length;
  document.getElementById('lobby-player-count').textContent = count;

  const list = document.getElementById('lobby-players-list');
  list.innerHTML = data.map(p =>
    `<div class="player-chip ${p.is_moderator ? 'mod' : ''}">${escHtml(p.name)}${p.is_moderator ? ' üé§' : ''}</div>`
  ).join('');

  document.getElementById('lobby-mod-btn').style.display = isModerator ? 'block' : 'none';
  document.getElementById('lobby-wait-msg').style.display = isModerator ? 'none' : 'block';
}

async function startGame() {
  await sb.from('game_state').update({
    phase: 'question',
    current_question: 0,
    question_start_time: new Date().toISOString()
  }).eq('id', 1);
}

// ============================================================
// QUESTION SCREEN
// ============================================================
function renderQuestionScreen(qIdx, startTimeStr) {
  showScreen('question');
  const q = QUESTIONS[qIdx];
  document.getElementById('q-num').textContent = qIdx + 1;
  document.getElementById('q-score').textContent = playerScore;
  document.getElementById('q-text').textContent = q.q;

  // Render answer buttons
  const grid = document.getElementById('answers-grid');
  grid.innerHTML = q.answers.map((a, i) =>
    `<button class="ans-btn ${hasAnswered && myAnswerIndex === i ? 'selected' : ''}"
      id="ans-${i}"
      onclick="selectAnswer(${i})"
      ${hasAnswered ? 'disabled' : ''}
    >${escHtml(a.text)}</button>`
  ).join('');

  document.getElementById('locked-msg').style.display = hasAnswered ? 'flex' : 'none';
  document.getElementById('mod-answer-status').style.display = isModerator ? 'flex' : 'none';
  if (isModerator) updateAnsweredCount();

  startTimer(startTimeStr);
}

function startTimer(startTimeStr) {
  stopTimer();
  const TOTAL = 15;
  const arc = document.getElementById('timer-arc');
  const numEl = document.getElementById('timer-num');
  const circumference = 226;

  function tick() {
    const elapsed = (Date.now() - new Date(startTimeStr).getTime()) / 1000;
    const remaining = Math.max(0, TOTAL - elapsed);
    const secs = Math.ceil(remaining);

    numEl.textContent = secs;
    arc.style.strokeDashoffset = circumference * (1 - remaining / TOTAL);

    if (remaining <= 5) {
      arc.classList.add('urgent');
      numEl.classList.add('urgent');
    } else {
      arc.classList.remove('urgent');
      numEl.classList.remove('urgent');
    }

    if (remaining <= 0) {
      stopTimer();
      if (!hasAnswered) {
        // Auto lock with no answer (score 0)
        lockAnswer(-1, 0, TOTAL);
      }
    }
  }

  tick();
  timerInterval = setInterval(tick, 200);
}

function stopTimer() {
  if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
}

async function selectAnswer(idx) {
  if (hasAnswered) return;
  const elapsed = (Date.now() - new Date(currentGameState.question_start_time).getTime()) / 1000;
  if (elapsed > 15) return;

  hasAnswered = true;
  myAnswerIndex = idx;
  const q = QUESTIONS[currentGameState.current_question];
  const rawScore = q.answers[idx].score;

  let multiplier = 1.0;
  if (elapsed <= 5) multiplier = 1.1;
  else if (elapsed <= 10) multiplier = 1.05;
  const earned = Math.round(rawScore * multiplier);
  myEarnedThisQ = earned;

  await lockAnswer(idx, earned, elapsed);
}

async function lockAnswer(idx, earned, elapsed) {
  const qIdx = currentGameState.current_question;

  // Update UI immediately
  const grid = document.getElementById('answers-grid');
  const btns = grid.querySelectorAll('.ans-btn');
  btns.forEach((b, i) => {
    b.disabled = true;
    if (i === idx) b.classList.add('selected');
  });
  document.getElementById('locked-msg').style.display = 'flex';
  showToast('‚ö° Answer locked in!');

  if (idx === -1) {
    // No answer (timeout)
    await sb.from('answers').insert({
      player_name: playerName,
      question_index: qIdx,
      answer_index: -1,
      raw_score: 0,
      multiplied_score: 0,
      time_taken: 15
    });
    return;
  }

  const q = QUESTIONS[qIdx];
  const rawScore = q.answers[idx].score;

  // Update score in DB
  const newScore = playerScore + earned;
  playerScore = newScore;
  document.getElementById('q-score').textContent = newScore;

  await sb.from('answers').insert({
    player_name: playerName,
    question_index: qIdx,
    answer_index: idx,
    raw_score: rawScore,
    multiplied_score: earned,
    time_taken: Math.round(elapsed * 10) / 10
  });
  await sb.from('players').update({ score: newScore }).eq('name', playerName);
}

async function updateAnsweredCount() {
  if (!currentGameState) return;
  const qIdx = currentGameState.current_question;
  const { count: answered } = await sb.from('answers').select('*', { count: 'exact', head: true }).eq('question_index', qIdx);
  const { count: total } = await sb.from('players').select('*', { count: 'exact', head: true });
  document.getElementById('answered-count').textContent = answered || 0;
  document.getElementById('total-count').textContent = `/ ${total || 0} answered`;
}

async function forceReveal() {
  stopTimer();
  await moveToReveal(currentGameState.current_question);
}

async function moveToReveal(qIdx) {
  await sb.from('game_state').update({ phase: 'reveal', current_question: qIdx }).eq('id', 1);
}

// ============================================================
// REVEAL SCREEN
// ============================================================
async function renderRevealScreen(qIdx) {
  showScreen('reveal');
  stopTimer();

  const q = QUESTIONS[qIdx];
  document.getElementById('reveal-qtext').textContent = q.q;

  // Fetch my answer for this question
  if (myAnswerIndex === -1 || myEarnedThisQ === undefined) {
    const { data: myAns } = await sb.from('answers')
      .select('*').eq('player_name', playerName).eq('question_index', qIdx).maybeSingle();
    if (myAns) { myAnswerIndex = myAns.answer_index; myEarnedThisQ = myAns.multiplied_score; }
  }

  // Fetch fresh player score
  const { data: me } = await sb.from('players').select('score').eq('name', playerName).maybeSingle();
  if (me) playerScore = me.score || 0;
  document.getElementById('reveal-total').textContent = playerScore;

  // My result
  const myResult = document.getElementById('my-result');
  if (myAnswerIndex >= 0) {
    const myAns = q.answers[myAnswerIndex];
    document.getElementById('my-answer-text').textContent = myAns.text;
    document.getElementById('my-earned').textContent = myEarnedThisQ || 0;
    if (myAnswerIndex === 0) {
      myResult.classList.add('correct-top');
      document.getElementById('top-answer-badge').style.display = 'inline-block';
      launchConfetti(30);
    } else {
      myResult.classList.remove('correct-top');
      document.getElementById('top-answer-badge').style.display = 'none';
    }
  } else {
    document.getElementById('my-answer-text').textContent = '(No answer)';
    document.getElementById('my-earned').textContent = 0;
    myResult.classList.remove('correct-top');
    document.getElementById('top-answer-badge').style.display = 'none';
  }

  // Build feud board
  const board = document.getElementById('feud-board');
  const maxScore = q.answers[0].score;
  board.innerHTML = q.answers.map((a, i) =>
    `<div class="feud-row" id="feud-row-${i}">
      <div class="feud-rank">${i + 1}</div>
      <div class="feud-answer-text">
        <div class="feud-bar" style="width:0%" id="feud-bar-${i}"></div>
        <span class="feud-answer-label">${escHtml(a.text)}</span>
      </div>
      <div class="feud-score">${a.score}</div>
    </div>`
  ).join('');

  // Animate rows in
  q.answers.forEach((a, i) => {
    setTimeout(() => {
      const row = document.getElementById(`feud-row-${i}`);
      if (row) {
        row.classList.add('revealed');
        setTimeout(() => {
          const bar = document.getElementById(`feud-bar-${i}`);
          if (bar) bar.style.width = `${(a.score / maxScore) * 100}%`;
        }, 100);
      }
    }, i * 180);
  });

  // Mod controls
  const isLastQ = qIdx === 19;
  const isCheckpoint = [4, 9, 14, 19].includes(qIdx);
  document.getElementById('reveal-mod-btn').style.display = isModerator ? 'block' : 'none';
  document.getElementById('reveal-wait-msg').style.display = isModerator ? 'none' : 'block';
  const nextBtn = document.getElementById('reveal-next-btn');
  if (isModerator) {
    if (isLastQ) {
      nextBtn.textContent = 'üèÜ View Final Results';
    } else if (isCheckpoint) {
      nextBtn.textContent = 'üèÜ View Standings';
    } else {
      nextBtn.textContent = '‚û°Ô∏è Next Question';
    }
  }
}

async function moderatorNext() {
  if (!isModerator) return;
  const qIdx = currentGameState.current_question;
  const isCheckpoint = [4, 9, 14, 19].includes(qIdx);
  const isLast = qIdx === 19;

  if (isLast) {
    // Show final leaderboard
    await sb.from('game_state').update({ phase: 'leaderboard', current_question: qIdx }).eq('id', 1);
  } else if (isCheckpoint) {
    await sb.from('game_state').update({ phase: 'leaderboard', current_question: qIdx }).eq('id', 1);
  } else {
    // Move to next question
    const nextQ = qIdx + 1;
    await sb.from('game_state').update({
      phase: 'question',
      current_question: nextQ,
      question_start_time: new Date().toISOString()
    }).eq('id', 1);
  }
}

// ============================================================
// LEADERBOARD SCREEN
// ============================================================
async function renderLeaderboardScreen(qIdx) {
  showScreen('leaderboard');

  const checkpointNum = qIdx + 1;
  document.getElementById('lb-title').textContent = `üèÜ Standings After Q${checkpointNum}`;
  const labels = { 5: 'Quarter Way!', 10: 'Half Way!', 15: 'Three Quarters!', 20: 'Final Results!' };
  document.getElementById('lb-subtitle').textContent = labels[checkpointNum] || '';

  const { data: players } = await sb.from('players').select('*').order('score', { ascending: false });
  if (!players) return;

  // Podium (top 3)
  renderPodium('podium-row', players.slice(0, 3));
  if (qIdx === 19) launchConfetti(80);

  // My rank
  const myRank = players.findIndex(p => p.name === playerName) + 1;
  const msgs = {
    1: "üëë Survey SAYS... You're dominating!",
    2: "üî• So close! Don't blink!",
    3: "ü•â Podium life! Keep pushing!",
  };
  const midMsg = "‚ö° You're in the game ‚Äî anything can happen!";
  const botMsg = "üòÖ Hey, the comeback starts NOW!";
  const myMsg = myRank <= 3 ? (msgs[myRank] || midMsg) : myRank <= Math.ceil(players.length / 2) ? midMsg : botMsg;
  document.getElementById('my-rank-msg').textContent = `You're #${myRank} ‚Äî ${myMsg}`;

  // Full list
  const list = document.getElementById('lb-full-list');
  list.innerHTML = players.map((p, i) => {
    const prev = prevLeaderboard.findIndex(pl => pl.name === p.name);
    const rank = i + 1;
    let delta = '‚Üí';
    let deltaClass = 'same';
    if (prev !== -1) {
      if (prev + 1 > rank) { delta = `‚Üë${prev + 1 - rank}`; deltaClass = 'up'; }
      else if (prev + 1 < rank) { delta = `‚Üì${rank - (prev + 1)}`; deltaClass = 'down'; }
    }
    return `<div class="lb-row ${p.name === playerName ? 'me' : ''}" style="animation-delay:${i * 60}ms">
      <div class="lb-rank">${rank}</div>
      <div class="lb-name">${escHtml(p.name)}${p.is_moderator ? ' üé§' : ''}${p.name === playerName ? ' (you)' : ''}</div>
      <div class="lb-score">${p.score || 0}</div>
      <div class="lb-delta ${deltaClass}">${delta}</div>
    </div>`;
  }).join('');

  prevLeaderboard = players.slice();

  // Moderator controls
  const isLast = qIdx === 19;
  document.getElementById('lb-mod-btn').style.display = isModerator ? 'block' : 'none';
  document.getElementById('lb-wait-msg').style.display = isModerator ? 'none' : 'block';
  const lbNextBtn = document.getElementById('lb-next-btn');
  if (isModerator) {
    if (isLast) {
      lbNextBtn.textContent = 'üéâ Show Final Results';
      lbNextBtn.onclick = async () => {
        await sb.from('game_state').update({ phase: 'end', current_question: qIdx }).eq('id', 1);
      };
    } else {
      lbNextBtn.textContent = '‚ñ∂Ô∏è Continue to Next Question';
      lbNextBtn.onclick = async () => {
        const nextQ = qIdx + 1;
        await sb.from('game_state').update({
          phase: 'question',
          current_question: nextQ,
          question_start_time: new Date().toISOString()
        }).eq('id', 1);
      };
    }
  }
}

function renderPodium(containerId, top3) {
  const container = document.getElementById(containerId);
  const trophies = ['ü•á', 'ü•à', 'ü•â'];
  const heights = ['90px', '70px', '55px'];
  // Reorder for podium display: 2nd, 1st, 3rd
  const order = top3.length === 1 ? [0] : top3.length === 2 ? [1, 0] : [1, 0, 2];
  container.innerHTML = order.map(i => {
    if (!top3[i]) return '';
    return `<div class="podium-item">
      <div class="podium-trophy">${trophies[i]}</div>
      <div class="podium-name">${escHtml(top3[i].name)}</div>
      <div class="podium-score">${top3[i].score || 0}</div>
      <div class="podium-block" style="height:${heights[i]}"></div>
    </div>`;
  }).join('');
}

// ============================================================
// END SCREEN
// ============================================================
async function renderEndScreen() {
  showScreen('end');
  launchConfetti(120);

  const { data: players } = await sb.from('players').select('*').order('score', { ascending: false });
  if (!players || players.length === 0) return;

  const winner = players[0];
  document.getElementById('end-headline').textContent = `üèÜ ${winner.name} knows this office better than anyone!`;

  renderPodium('end-podium-row', players.slice(0, 3));

  const list = document.getElementById('end-lb-list');
  list.innerHTML = players.map((p, i) =>
    `<div class="lb-row ${p.name === playerName ? 'me' : ''}" style="animation-delay:${i * 60}ms">
      <div class="lb-rank">${['ü•á','ü•à','ü•â'][i] || `#${i + 1}`}</div>
      <div class="lb-name">${escHtml(p.name)}${p.name === playerName ? ' (you)' : ''}</div>
      <div class="lb-score">${p.score || 0} pts</div>
    </div>`
  ).join('');
}

// ============================================================
// ONLINE COUNT
// ============================================================
async function updateOnlineCount() {
  const { count } = await sb.from('players').select('*', { count: 'exact', head: true });
  document.getElementById('online-count').textContent = `${count || 0} online`;
}

// ============================================================
// CONFETTI
// ============================================================
function launchConfetti(count = 60) {
  const canvas = document.getElementById('confetti-canvas');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  const ctx = canvas.getContext('2d');
  const colors = ['#FFD700', '#FFA500', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#ffffff'];
  const particles = Array.from({ length: count }, () => ({
    x: Math.random() * canvas.width,
    y: -10,
    w: Math.random() * 10 + 5,
    h: Math.random() * 6 + 3,
    color: colors[Math.floor(Math.random() * colors.length)],
    vx: (Math.random() - 0.5) * 4,
    vy: Math.random() * 4 + 2,
    rot: Math.random() * 360,
    vr: (Math.random() - 0.5) * 10
  }));
  let frame = 0;
  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    particles.forEach(p => {
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot * Math.PI / 180);
      ctx.fillStyle = p.color;
      ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
      ctx.restore();
      p.x += p.vx; p.y += p.vy; p.rot += p.vr;
      p.vy += 0.05;
    });
    frame++;
    if (frame < 180) requestAnimationFrame(draw);
    else ctx.clearRect(0, 0, canvas.width, canvas.height);
  }
  draw();
}

// ============================================================
// TOAST
// ============================================================
let toastTimeout;
function showToast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimeout);
  toastTimeout = setTimeout(() => el.classList.remove('show'), 2500);
}

// ============================================================
// SCREEN MANAGER
// ============================================================
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const el = document.getElementById(`screen-${name}`);
  if (el) {
    el.classList.add('active');
    window.scrollTo(0, 0);
  }

  // Refresh lobby player list when on lobby
  if (name === 'lobby') refreshPlayerList();
}

// ============================================================
// UTILITY
// ============================================================
function showMsg(elId, msg, type) {
  const el = document.getElementById(elId);
  if (!el) return;
  el.innerHTML = `<div class="msg msg-${type}">${msg}</div>`;
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ============================================================
// START
// ============================================================
init();
</script>
</body>
</html>
